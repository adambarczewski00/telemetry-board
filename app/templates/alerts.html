{% extends "base.html" %}
{% block content %}
<hgroup>
  <h2>Alerts</h2>
  <p>Browse recent alerts by asset. Creation form will be added later.</p>
  <p><a href="/ui">Back</a></p>
</hgroup>

<label for="asset-select">Asset</label>
<select id="asset-select"></select>
<p id="assets-empty" style="display:none"><em>No assets yet. Add one via POST /assets.</em></p>

<table>
  <thead>
    <tr><th>Time</th><th class="num">Window</th><th class="num">Change %</th></tr>
  </thead>
  <tbody id="alerts-body"></tbody>
  </table>
{% endblock %}

{% block scripts %}
<script data-cfasync="false">
  document.addEventListener('DOMContentLoaded', () => {
  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function populateAssets() {
    const sel = document.getElementById('asset-select');
    sel.innerHTML = '';
    let assets = [];
    try {
      assets = await fetchJSON('/assets/');
    } catch (e) {
      const tbody = document.getElementById('alerts-body');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><em>Failed to load assets (${String(e)}).</em></td>`;
      tbody.appendChild(tr);
      return;
    }
    const empty = document.getElementById('assets-empty');
    if (!assets.length) {
      empty.style.display = '';
      return;
    }
    empty.style.display = 'none';
    for (const a of assets) {
      const opt = document.createElement('option');
      opt.value = a.symbol; opt.textContent = a.symbol;
      sel.appendChild(opt);
    }
    if (assets.length) sel.value = assets[0].symbol;
  }

  async function loadAlerts() {
    const sel = document.getElementById('asset-select');
    const tbody = document.getElementById('alerts-body');
    tbody.innerHTML = '';
    if (!sel.value) return;
    let alerts = [];
    try {
      alerts = await fetchJSON(`/alerts/?asset=${encodeURIComponent(sel.value)}&limit=50`);
    } catch (e) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><em>Failed to load alerts (${String(e)}).</em></td>`;
      tbody.appendChild(tr);
      return;
    }
    if (!alerts.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><em>No alerts yet.</em></td>`;
      tbody.appendChild(tr);
      return;
    }
    for (const a of alerts) {
      const tr = document.createElement('tr');
      const ts = new Date(a.triggered_at).toLocaleString();
      const pct = Number(a.change_pct);
      const signClass = pct >= 0 ? 'delta-pos' : 'delta-neg';
      tr.innerHTML = `<td>${ts}</td><td class=\"num\">${a.window_minutes}m</td><td class=\"num ${signClass}\">${pct.toFixed(2)}%</td>`;
      tbody.appendChild(tr);
    }
  }

  async function init() {
    await populateAssets();
    await loadAlerts();
    document.getElementById('asset-select').addEventListener('change', loadAlerts);
    setInterval(loadAlerts, 15000);
  }

  init();
  });
</script>
{% endblock %}
