{% extends "base.html" %}
{% block content %}
<hgroup>
  <h2>Asset: {{ symbol }}</h2>
  <p>Price history and recent alerts.</p>
  <p><a href="/ui">Back</a></p>
</hgroup>

<article>
  <header>
    <strong>Price history (24h)</strong>
  </header>
  <canvas id="chart" height="100"></canvas>
  <p id="chart-empty" style="display:none"><em>No price data yet for this asset.</em></p>
  <footer>
    <small>Updates every 15s</small>
  </footer>
  </article>

<h3>Recent Alerts</h3>
<table>
  <thead>
    <tr><th>Time</th><th>Window</th><th>Change %</th></tr>
  </thead>
  <tbody id="alerts-body"></tbody>
  </table>
{% endblock %}

{% block scripts %}
<script>
  const SYMBOL = {{ symbol|tojson }};

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  let chart;
  function ensureChart(ctx) {
    if (chart) return chart;
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: SYMBOL, data: [], fill: false, tension: 0.2 }] },
      options: { scales: { x: { ticks: { maxTicksLimit: 8 } } } }
    });
    return chart;
  }

  async function loadChart() {
    const prices = await fetchJSON(`/prices?asset=${encodeURIComponent(SYMBOL)}&window=24h`);
    const empty = document.getElementById('chart-empty');
    if (!prices.length) {
      empty.style.display = '';
      const c = ensureChart(document.getElementById('chart').getContext('2d'));
      c.data.labels = [];
      c.data.datasets[0].data = [];
      c.update();
      return;
    }
    empty.style.display = 'none';
    const labels = prices.map(p => new Date(p.ts).toLocaleTimeString());
    const data = prices.map(p => Number(p.price));
    const ctx = document.getElementById('chart').getContext('2d');
    const c = ensureChart(ctx);
    c.data.labels = labels;
    c.data.datasets[0].data = data;
    c.update();
  }

  async function loadAlerts() {
    const tbody = document.getElementById('alerts-body');
    tbody.innerHTML = '';
    const alerts = await fetchJSON(`/alerts?asset=${encodeURIComponent(SYMBOL)}&limit=20`);
    if (!alerts.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3"><em>No alerts yet.</em></td>`;
      tbody.appendChild(tr);
      return;
    }
    for (const a of alerts) {
      const tr = document.createElement('tr');
      const ts = new Date(a.triggered_at).toLocaleString();
      tr.innerHTML = `<td>${ts}</td><td>${a.window_minutes}m</td><td>${Number(a.change_pct).toFixed(2)}%</td>`;
      tbody.appendChild(tr);
    }
  }

  function refresh() {
    loadChart();
    loadAlerts();
  }

  refresh();
  setInterval(refresh, 15000);
</script>
{% endblock %}
