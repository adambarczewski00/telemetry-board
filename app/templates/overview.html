{% extends "base.html" %}
{% block content %}
<hgroup>
  <h2>Assets Overview</h2>
  <p>List of tracked assets with last price and 24h change.</p>
</hgroup>

<table>
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Name</th>
      <th>Last Price</th>
      <th>24h Change</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="assets-body"></tbody>
  </table>
{% endblock %}

{% block scripts %}
<script>
  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function pct(a, b) {
    if (b === 0) return 0;
    return ((a - b) / b) * 100.0;
  }

  async function load() {
    const tbody = document.getElementById('assets-body');
    tbody.innerHTML = '';
    const assets = await fetchJSON('/assets');
    if (!assets.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5"><em>No assets yet. POST /assets {\"symbol\":\"BTC\"} to add one.</em></td>`;
      tbody.appendChild(tr);
      return;
    }
    for (const a of assets) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.symbol}</td><td>${a.name ?? ''}</td><td>—</td><td>—</td><td><a href="/ui/assets/${a.symbol}">Open</a></td>`;
      tbody.appendChild(tr);
      try {
        const prices = await fetchJSON(`/prices?asset=${encodeURIComponent(a.symbol)}&window=24h`);
        if (prices.length > 0) {
          const last = prices[prices.length - 1].price;
          const first = prices[0].price;
          tr.children[2].textContent = Number(last).toFixed(2);
          const change = pct(last, first);
          tr.children[3].textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
        } else {
          tr.children[2].textContent = '—';
          tr.children[3].textContent = '—';
        }
      } catch (e) {
        tr.children[2].textContent = 'n/a';
        tr.children[3].textContent = 'n/a';
      }
    }
  }

  load();
  // simple polling
  setInterval(load, 15000);
</script>
{% endblock %}
